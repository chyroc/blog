<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.54.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>使用加 1 项目体验 golang 的 wasm &middot; Chyroc的博客</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://chyroc.cn/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://chyroc.cn/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://chyroc.cn/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://chyroc.cn/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://chyroc.cn"><h1>Chyroc的博客</h1></a>
      <p class="lead">
      
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://chyroc.cn">Home</a> </li>
        <li><a href="/"> 主页 </a></li><li><a href="/blogroll/"> 友链 </a></li><li><a href="/about/"> 关于 </a></li>
      </ul>
    </nav>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>使用加 1 项目体验 golang 的 wasm</h1>
  <time datetime=2018-06-20T17:45:48&#43;0800 class="post-date">2018-06-20 17:45:48</time>
  

<h2 id="什么是-webassembly">什么是 WebAssembly</h2>

<p>WebAssembly（以下简称 wasm）是一种新的编码方式，可以在现代的网络浏览器中运行。啥意思，就是除了 JavaScript（以下简称 js），还有一种语言可以在浏览器里面运行了！</p>

<p>对于网络平台而言，WebAssembly 具有巨大的意义——它提供了一条途径，以使得以各种语言编写的代码都可以以接近原生的速度在 Web 中运行。在这种情况下，以前无法以此方式运行的客户端软件都将可以运行在 Web 中。</p>

<h2 id="编译支持-wasm-的-go">编译支持 wasm 的 go</h2>

<p>golang 的 release 版本（1.10）还不支持 wasm，但是在 github.com/golang/go 的 master 分支中已经包含 wasm 了，所以我们需要自己编译一个 go。</p>

<pre><code class="language-bash">git clone http://github.com/golang/go /path/go
cd /path/go/src
./make.bash
</code></pre>

<p><code>/path/go/bin/</code>目录下会生成编译后的 go：<code>/path/go/bin/go</code></p>

<p>设置<code>GOROOT</code>为<code>/path/go/</code></p>

<h2 id="创建自己的-wasm-程序">创建自己的 wasm 程序</h2>

<p>参见项目：<a href="https://github.com/Chyroc/golang-wasm-example">https://github.com/Chyroc/golang-wasm-example</a></p>

<h3 id="index-html">index.html</h3>

<p><code>index.html</code>引入了<code>wasm_exec.js</code>（这个是从<code>/path/go/misc/wasm/wasm_exec.js</code>复制来过的）和加载 wasm 的 js（这个参见参见<a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/Loading_and_running#%E4%BD%BF%E7%94%A8Fetch">文档</a>），总之这样我们的 wasm 就已经加载到我们的网页了</p>

<p>最后有一个显示数字的 span 块，和两个<kbd>+</kbd>和<kbd>-</kbd>的 button，我们待会写的 wasm 代码就是操作这个 span 块的</p>

<pre><code class="language-html">&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;加1减1&lt;/title&gt;
    &lt;script src=&quot;wasm_exec.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        function fetchAndInstantiate(url, importObject) {
            return fetch(url).then(response =&gt;
                    response.arrayBuffer()
            ).then(bytes =&gt;
                    WebAssembly.instantiate(bytes, importObject)
            ).then(results =&gt;
                    results.instance
            );
        }

        var go = new Go();
        var mod = fetchAndInstantiate(&quot;./example.wasm&quot;, go.importObject);
        window.onload = function () {
            mod.then(function (instance) {
                go.run(instance);
            });
        };
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;br&gt;
&lt;div&gt;加1减1&lt;/div&gt;
&lt;br&gt;
&lt;button id=&quot;minus&quot; type=&quot;button&quot; disabled=true&gt;-&lt;/button&gt;
&lt;span id=&quot;number&quot;&gt;0&lt;/span&gt;
&lt;button id=&quot;plus&quot; type=&quot;button&quot; disabled=true&gt;+&lt;/button&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h3 id="wasm-go">wasm.go</h3>

<p>第一行有 build tag：<code>// +build js,wasm</code>表示<code>GOARCH</code>是<code>wasm</code>，<code>GOOS</code>是<code>js</code></p>

<p>然后<code>syscall/js</code>包提供了操作网页的接口：</p>

<p><code>js.Global.Get(&quot;document&quot;).Call(&quot;getElementById&quot;, &quot;number&quot;)</code>这几行获取到刚刚<code>index.html</code>中最后一个按钮和 span 块</p>

<p>全局变量<code>number</code>是我们最后操作的数字</p>

<p>然后对<kbd>+</kbd>和<kbd>-</kbd>按钮添加事件监听，监听到按了<kbd>+</kbd>，就将<code>number</code>加 1；监听到按了<kbd>-</kbd>，就将<code>number</code>减 1；并渲染 span 块。</p>

<p><code>plus.Set(&quot;disabled&quot;, false)</code>这两句会在页面 wasm 加载后将<kbd>+</kbd>和<kbd>-</kbd>按钮 disable 状态去掉，变成可点击状态</p>

<p>最后使用<code>select{}</code>阻塞 go 程序不退出</p>

<pre><code class="language-go">// +build js,wasm

package main

import (
	&quot;syscall/js&quot;
	&quot;strconv&quot;
)

func main() {
	var numberDoc = js.Global.Get(&quot;document&quot;).Call(&quot;getElementById&quot;, &quot;number&quot;)
	var plus = js.Global.Get(&quot;document&quot;).Call(&quot;getElementById&quot;, &quot;plus&quot;)
	var minus = js.Global.Get(&quot;document&quot;).Call(&quot;getElementById&quot;, &quot;minus&quot;)
	var number int

	plus.Call(&quot;addEventListener&quot;, &quot;click&quot;, js.NewCallback(func(args []js.Value) {
		println(&quot;press +&quot;)
		number++
		numberDoc.Set(&quot;innerHTML&quot;, strconv.Itoa(number))
	}))

	minus.Call(&quot;addEventListener&quot;, &quot;click&quot;, js.NewCallback(func(args []js.Value) {
		number--
		numberDoc.Set(&quot;innerHTML&quot;, strconv.Itoa(number))
		println(&quot;press -&quot;)
	}))

	plus.Set(&quot;disabled&quot;, false)
	minus.Set(&quot;disabled&quot;, false)

	select {}
}
</code></pre>

<p>程序效果请访问：<a href="https://blog.chyroc.cn/golang-wasm-example/">https://blog.chyroc.cn/golang-wasm-example/</a> 体验</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://blog.gopheracademy.com/advent-2017/go-wasm/">https://blog.gopheracademy.com/advent-2017/go-wasm/</a></li>
<li><a href="https://github.com/neelance/go/issues/29">https://github.com/neelance/go/issues/29</a></li>
<li><a href="https://blog.csdn.net/garfielder007/article/details/68215694">https://blog.csdn.net/garfielder007/article/details/68215694</a></li>
</ul>

</div>


<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script src="../../js/jquery-3.3.1.min.js"></script>
<script src="../../js/code.js"></script>
<script src="../../css/highlight.css"></script>

<script src="../../js/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init();</script>

<script>
hljs.configure({languages: []});
hljs.initHighlightingOnLoad();
</script>


  
  <hr/>
  &copy; <a href="https://chyroc.cn">chyroc</a> <a href="https://github.com/spf13/hyde">Theme By hyde</a> 2020
  
  <span id="reading-statistics"/><span>

  

<div id="git-comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
  var gitment = new Gitment({
    id: 'use-plus-one-to-experience-golang-wasm',
    title: '使用加 1 项目体验 golang 的 wasm',
    owner: 'Chyroc',
    repo: 'chyroc.github.io',
    oauth: {
      client_id: '36628d87f0ace3c0f34c',
      client_secret: '814e29f878a31ddf2a0f8f010c2bc3615750a998',
    }
  })
  gitment.render('git-comments')
</script>






    </main>

    
      
    
  </body>
</html>
