<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.54.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>mongodb 的 ObjectId &middot; Chyroc的博客</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://chyroc.cn/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://chyroc.cn/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://chyroc.cn/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://chyroc.cn/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class="theme-base-08 ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://chyroc.cn"><h1>Chyroc的博客</h1></a>
      <p class="lead">
      
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://chyroc.cn">Home</a> </li>
        <li><a href="/"> 主页 </a></li><li><a href="/blogroll/"> 友链 </a></li><li><a href="/about/"> 关于 </a></li>
      </ul>
    </nav>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>mongodb 的 ObjectId</h1>
  <time datetime=2017-07-18T16:50:57&#43;0800 class="post-date">2017-07-18 16:50:57</time>
  

<h2 id="官方文档解释">官方文档解释</h2>

<p><code>ObjectId(&lt;hexadecimal&gt;)</code></p>

<p>这是一个 12 字节（12-byte）的 <a href="https://docs.mongodb.com/manual/reference/bson-types/#objectid">ObjectId</a>，其中包括：</p>

<ul>
<li>4 字节的 unix 秒级时间戳（即 10 位的时间戳）,</li>
<li>3 字节的机器代码,</li>
<li>2 字节的进程代码</li>
<li>3 自己的计数器（从一个随机数开始）</li>
</ul>

<p>可选参数：</p>

<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>hexadecimal</code></td>
<td>String</td>
<td>可选，16 进制字符串</td>
</tr>
</tbody>
</table>

<p>ObjectId() 有以下属性和方法:</p>

<table>
<thead>
<tr>
<th>Attribute/Method</th>
<th align="left">Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>str</td>
<td align="left">返回这个 id 的 16 进制表示的字符串</td>
</tr>

<tr>
<td>ObjectId.getTimestamp()</td>
<td align="left">返回这个 id 编码的时间戳</td>
</tr>

<tr>
<td>ObjectId.toString()</td>
<td align="left">返回字符串： <code>ObjectId(...)</code></td>
</tr>

<tr>
<td>ObjectId.valueOf()</td>
<td align="left">就是 属性 <code>str</code>返回的那个，一样的</td>
</tr>
</tbody>
</table>

<h1 id="解释一个真实的-id">解释一个真实的 id</h1>

<pre><code>596cee8fd68096396dc0390b
</code></pre>

<h2 id="时间戳">时间戳</h2>

<p>一个秒级的时间戳是 10 位十进制数的，如果采用无符号表示方法，那么 n 位二进制（n 个 bit）可以表示的最大数字是 <code>2^n-1</code>，现在需要表示秒级时间戳，就需要 m bit 的空间，也就是：</p>

<p>$$2^m - 1 &gt;= 10^9$$
$$m &gt;= log_{2}^(10^9 + 1)$$
$$m &gt;= 29.8974$$</p>

<p>不过注意哈，objectid 是用 16 进制表示的，我们知道 4 位二进制对应于 1 位 16 进制，所以要么是 8 位（对应于 32 位二进制），满足
$$m &gt;= 29.8974$$
要么是 7 位 16 进制（对应于 28 位二进制），不满足
$$m &gt;= 29.8974$$
所以很显然，<strong>m 取 32，也就是说用 8 位 16 进制字符串（32bit）表示一个时间戳</strong>
这个在定义中就明确了：<code>4字节的unix秒级时间戳</code>，即 32bit</p>

<h2 id="分割-objectid">分割 ObjectId</h2>

<pre><code>596cee8fd68096396dc0390b =&gt; 596cee8f  d68096  396d  c0390b
</code></pre>

<p><code>596cee8f</code>是 16 进制时间戳，转化为 10 进制： <code>sadf</code>
<code>d68096</code>是机器代码，不会变
<code>396d</code>是进程代码，不会变
<code>c0390b</code>是计数器，从随机数开始增加</p>

<h2 id="创建-objectid">创建 ObjectId</h2>

<p><img src="https://media.chyroc.cn/img/mongodb-object-id.png" alt="" /></p>

<p>可以看到，数据符合我们的预期，中间两个代码没有变，前面的增加的是秒数，后面的是计数器（+1）</p>

<h1 id="引用">引用</h1>

<ul>
<li><a href="https://docs.mongodb.com/manual/reference/method/ObjectId/">官方文档</a></li>
<li><a href="http://jzqt.github.io/2015/06/30/Markdown%E4%B8%AD%E5%86%99%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/">latex 写公式</a></li>
</ul>

</div>


<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script src="../../js/jquery-3.3.1.min.js"></script>
<script src="../../js/code.js"></script>
<script src="../../css/highlight.css"></script>

<script src="../../js/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init();</script>

<script>
hljs.configure({languages: []});
hljs.initHighlightingOnLoad();
</script>


  
  <hr/>
  &copy; <a href="https://chyroc.cn">chyroc</a> <a href="https://github.com/spf13/hyde">Theme By hyde</a> 2020
  
  <span id="reading-statistics"/><span>

  

<div id="git-comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
  var gitment = new Gitment({
    id: 'mongo-object-id',
    title: 'mongodb 的 ObjectId',
    owner: 'Chyroc',
    repo: 'chyroc.github.io',
    oauth: {
      client_id: '36628d87f0ace3c0f34c',
      client_secret: '814e29f878a31ddf2a0f8f010c2bc3615750a998',
    }
  })
  gitment.render('git-comments')
</script>






    </main>

    
      
    
  </body>
</html>
