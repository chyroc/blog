<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>bigqueue 源码阅读 | Chyroc的博客</title><link rel=stylesheet href=/css/style.css><link href=//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css rel=stylesheet></head><body><nav><ul class=menu><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>bigqueue 源码阅读</span></h1><h2 class=date>2019/03/18</h2></div><main><h1 id=grandecola-bigqueue-https-github-com-grandecola-bigqueue-源码阅读><a href=https://github.com/grandecola/bigqueue>grandecola/bigqueue</a> 源码阅读</h1><h2 id=依赖>依赖</h2><ul><li><a href=github.com/grandecola/mmap>grandecola/mmap</a></li></ul><p>也是 bigqueue 作者写的一个 mmap 的 go 实现。</p><p>在博客 <a href=https://chyroc.cn/posts/source-tiedot-i/>tiedot 阅读笔记（一）</a> 里面，tidot 也是使用了一个 go 实现的 mmap 库，不过 tiedot 用的是 <a href=https://github.com/edsrzf/mmap-go>edsrzf/mmap-go</a>。</p><h2 id=文件和数据结构>文件和数据结构</h2><p>bigqueue 的数据都是存在文件中的，具体如下：</p><ol><li>所有的文件都是在一个文件夹中<ul><li>这个文件在创建 BigQueue 对象的时候指定 <code>NewBigQueue(path)</code></li></ul></li><li>文件类型只有两种<ul><li>文件 index.dat<ul><li>存储 5 个数据（共 40bytes）<ul><li>第一个 8 字节存储第一个数据块所在的文件 id</li><li>第二个 8 字节存储第一个数据块在文件中的 offset</li><li>第三个 8 字节存储最后一个数据块所在的文件 id</li><li>第四个 8 字节存储最后一个数据块在文件中的 offset</li><li>第五个 8 字节存储的是单个文件的大小（数据文件，默认 128M，可以通过配置修改）</li></ul></li></ul></li><li>文件 arena_<id>.dat<ul><li>id 从 0 开始</li><li>文件内容由数据块组成</li><li>由于数据块的寻址地址由 index.dat 指定，所以文件中除了数据块，没有其他数据（如没有索引数据，没有分隔数据）</li><li>每个数据块由两部分组成<ul><li>数据块的长度，一个 uint64 类型，8 字节</li><li>实际的数据，len(body) 字节</li></ul></li></ul></li></ul></li></ol><h2 id=怎么写入数据>怎么写入数据</h2><ol><li>通过 index.dat 找到最后一个数据块所在的文件 id 和 offset</li><li>写入数据长度（如果文件剩余空间不够，少于 8 字节，则写入下一个文件首部）</li><li>写入数据（for-loop 写，记录已经写入的长度，等于 length 的时候，退出）</li><li>更新最后一个数据块所在的文件 id 和 offset</li></ol><h2 id=怎么读数据>怎么读数据</h2><ol><li>通过 index.dat 找到第一个数据块所在的文件 id 和 offset</li><li>读 length（如果文件剩余空间不够，少于 8 字节，则从下一个文件首部读）</li><li>根据 length 读这么长的数据</li><li>如果不是仅读，更新第一个数据块所在的文件 id 和 offset</li></ol><h2 id=有啥总结的>有啥总结的</h2><ul><li>binary 的常规操作<ul><li>使用 mmap</li><li>length + content 的存储结构</li></ul></li><li>针对不同的场景选择不同的数据结构，在 queue 里面，不考虑取 index，只需要首尾 id 即可，可以介绍寻址消耗和空间消耗</li><li>一个 content 被两个文件截断的存储<ul><li>第一个文件存储一部分，第二个文件存储一部分</li><li>保证：</li><li>已经已经 content 长度</li><li>文件有序</li></ul></li><li>通过 benchmark 找到最合适的配置</li></ul></main><footer><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>&copy; <a href=https://chyroc.cn>chyroc</a> <a href=https://themes.gohugo.io/hugo-xmin/>Theme By hyde</a> 2021
<span id=reading-statistics><span></footer><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'source-read-bigqueue',title:'bigqueue 源码阅读',owner:'Chyroc',repo:'chyroc.github.io',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></body></html>