<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>int16 溢出 bug 记录 | Chyroc的博客</title><link rel=stylesheet href=/css/style.css><link href=//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css rel=stylesheet></head><body><nav><ul class=menu><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>int16 溢出 bug 记录</span></h1><h2 class=date>2017/07/31</h2></div><main><p>在一个业务中用到了 token（介绍参见<a href=../token-token-authentication-authorization/>这里</a>）</p><p>加密：将各种信息+生成时间(issueTime)+有效期(ttl)利用私钥加密，然后 base64。</p><p>判断过期的时候，会首先去检查 token 里面编码的 <code>issueTime+ttl</code>，和<code>time.now</code>对比。</p><p>但是呢，为了减少 token 的长度，<code>ttl</code>是 int16 类型的（单位分钟），所以最大存储 32768。而我们需要存储一星期的 token，也就是 7*24*60 = 10080。</p><p>哈哈，本来是没有问题的，bug 就是出现在下面一点。</p><p>计算过期：</p><pre><code class=language-go>if issueTime + uint32(ttl*60) &lt; time.Now().Unix() {
    // 过期
}
</code></pre><p>我刚开始是认为 ttl 虽然是 int16 的，但是外面包了一层 uint32，所以结果没什么问题。可是<code>ttl*60</code>的结果直接就溢出了，所以就算外面包了一层，也没有任何影响。最终的结果还是溢出。。</p><p>改进：</p><pre><code class=language-go>if issueTime + uint32(ttl)*60 &lt; time.Now().Unix() {
    // 过期
}
</code></pre><p>bug 记录。</p></main><footer><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>&copy; <a href=https://chyroc.cn>chyroc</a> <a href=https://themes.gohugo.io/hugo-xmin/>Theme By hyde</a> 2021
<span id=reading-statistics><span></footer><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'int16-overflow-bug-record',title:'int16 溢出 bug 记录',owner:'Chyroc',repo:'chyroc.github.io',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></body></html>