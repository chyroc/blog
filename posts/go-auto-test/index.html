<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>go 中的自动测试 | Chyroc的博客</title><link rel=stylesheet href=/css/style.css><link href=//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css rel=stylesheet></head><body><nav><ul class=menu><li><a href=/>主页</a></li><li><a href=/blogroll/>友链</a></li><li><a href=/about/>关于</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>go 中的自动测试</span></h1><h2 class=date>2018/05/18</h2></div><main><h2 id=前言>前言</h2><p>最近在做 leetcode 的题目，需要搞一些简单的测试代码，但是测试函数的输入输出的描述、判断函数是否成功比较麻烦</p><p>所以我就在想，能不能我定义一个 input 和一个 output，能够自动的将 input 转成 go 的代码，然后执行测试函数之后，比较返回值和 output 是否一致</p><p>要想这么做，肯定需要使用到反射，并且需要定义一下怎么从字符串转化到 go 的代码</p><h2 id=parse-字符串定义>parse 字符串定义</h2><ul><li>用逗号分隔数组的各个元素</li><li>用<code>\n</code>分隔多个输入或者多个输出</li><li><code>[1,2,3]</code> 定义 slice</li><li><code>{a: b}</code> 定义 map</li><li>slice 或者 map 中的子元素的类型要看函数定义参数的类型</li></ul><h2 id=代码解析>代码解析</h2><h3 id=parseparam-这里需要自定义-string-转化>parseParam 这里需要自定义 string 转化</h3><p>参数是<code>string</code> / <code>reflect.Type</code>，返回值是<code>reflect.Value</code></p><p>主要是<code>tring</code> to <code>int</code>,<code>bool</code>,<code>slice</code>,<code>map</code>，并转成<code>reflect.Value</code>的类型</p><pre><code class=language-go>func parseParam(t *testing.T, param string, typ reflect.Type) reflect.Value {
	var r reflect.Value
	var as = assert.New(t)
	param = strings.TrimSpace(param)

	switch typ.Kind() {
	case reflect.Int:
		i, err := strconv.Atoi(param)
		as.Nil(err)
		r = reflect.ValueOf(i)
	case reflect.String:
		r = reflect.ValueOf(param)
	case reflect.Bool:
		b, err := strconv.ParseBool(param)
		as.Nil(err)
		r = reflect.ValueOf(b)
	case reflect.Slice:
		as.True(len(param) &gt; 1)
		as.True(strings.HasPrefix(param, &quot;[&quot;))
		as.True(strings.HasSuffix(param, &quot;]&quot;))
		param = strings.TrimPrefix(param, &quot;[&quot;)
		param = strings.TrimSuffix(param, &quot;]&quot;)
		s2 := strings.Split(param, &quot;,&quot;)

		r = reflect.MakeSlice(reflect.SliceOf(typ.Elem()), 0, 0)
		for _, v := range s2 {
			r = reflect.Append(r, parseParam(t, v, typ.Elem()))
		}
	default:
		panic(fmt.Sprintf(&quot;not support %s&quot;, typ.Kind()))
	}

	return r
}
</code></pre><h3 id=输入参数解析>输入参数解析</h3><pre><code class=language-go>ft := reflect.TypeOf(Func)
fv := reflect.ValueOf(Func)
</code></pre><p>然后遍历 reflect.TypeOf(Func).In(i)，这个是输入参数的类型</p><p>将输入参数字符串转成对应类型的 go 代码：ithParamIn := parseParam(t, input[i], ithCallInType)</p><pre><code class=language-go>var in []reflect.Value
for i := 0; i &lt; ft.NumIn(); i++ {
	ithCallInType := ft.In(i)

	ithParamIn := parseParam(t, input[i], ithCallInType)

	in = append(in, ithParamIn)
}
</code></pre><h3 id=执行测试函数>执行测试函数</h3><pre><code class=language-go>out := fv.Call(in)
</code></pre><p>这边的 out 是一个[]reflect.Value，需要将他和函数签名，以及给定的输出的字符串进行比较</p><h3 id=输出参数解析和验证>输出参数解析和验证</h3><p>out 有三个，call 返回，ft.Out(i)的，output 的</p><pre><code class=language-go>for i := 0; i &lt; ft.NumOut(); i++ {
	ithCallRealOut := out[i] // 比input多的
	ithCallOutType := ft.Out(i)
	ithCallOut := parseParam(t, output[i], ithCallOutType)

	as.Equal(ithCallOut.Kind(), ithCallRealOut.Kind())
	as.Equal(ithCallOut.Kind(), ithCallRealOut.Convert(ithCallOutType).Kind())
	as.Equal(ithCallOut.Interface(), ithCallRealOut.Convert(ithCallOutType).Interface())
}
</code></pre><h2 id=所以看看这怎么用>所以看看这怎么用</h2><p>可以看到只要给了 input 和 output 的字符串，和要测试的函数，那么就能通过反射自动解析参数，执行测试代码，并看看是不是给定的输出</p><script src=https://gist.github.com/Chyroc/8dc21c2ea65dc3c83e43a62b3f2759e8.js></script><h2 id=代码-地址-1>代码（<a href=https://github.com/Chyroc/algorithms-go/blob/master/test/run_case.go>地址</a>）</h2><script src=https://gist.github.com/Chyroc/3be97f3fc601a0a851e2bddbda48d89b.js></script></main><footer><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src=../../js/jquery-3.3.1.min.js></script><script src=../../js/code.js></script><script src=../../css/highlight.css></script><script src=../../js/instantclick.min.js data-no-instant></script><script data-no-instant>InstantClick.init();</script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr>&copy; <a href=https://chyroc.cn>chyroc</a> <a href=https://themes.gohugo.io/hugo-xmin/>Theme By hyde</a> 2021
<span id=reading-statistics><span></footer><div id=git-comments></div><link rel=stylesheet href=https://imsun.github.io/gitment/style/default.css><script src=https://imsun.github.io/gitment/dist/gitment.browser.js></script><script>var gitment=new Gitment({id:'go-auto-test',title:'go 中的自动测试',owner:'Chyroc',repo:'chyroc.github.io',oauth:{client_id:'36628d87f0ace3c0f34c',client_secret:'814e29f878a31ddf2a0f8f010c2bc3615750a998',}})
gitment.render('git-comments')</script></body></html>